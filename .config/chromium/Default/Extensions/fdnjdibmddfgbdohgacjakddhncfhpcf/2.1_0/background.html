<!DOCTYPE html>
<!--
 * Copyright (c) 2010 Jared Wein, Matt Wein. All rights reserved.  Use of this
 * source code is governed by the Apache 2.0 license that can be found in the
 * LICENSE file.
-->
<html>
  <head>
    <script>
      kPopupKey = "alreadyShownPopup";
      alreadyShownPopup = function() {
        return localStorage[kPopupKey] == "true";
      }

      setupPopupIfNecessary = function(tabId) {
        if (!alreadyShownPopup()) {
          chrome.pageAction.setPopup({tabId:tabId, popup:"popup.html"});
        }
      }

      window.willExpand = true;
      toggleExtensionState = function(tab) {
        var iconPath;
        var iconTitle;
        if (window.willExpand) {
          iconPath = 'icon-16-contract.png';
          iconTitle = chrome.i18n.getMessage("contractStateTitle");
          chrome.pageAction.setPopup({tabId:tab.id, popup:""});
          localStorage[kPopupKey] = "true";
        } else {
          iconPath = 'icon-16-expand.png';
          iconTitle = chrome.i18n.getMessage("expandStateTitle");
          setupPopupIfNecessary(tab.id);
        }
        chrome.pageAction.setIcon({path:iconPath, tabId:tab.id});
        chrome.pageAction.setTitle({title:iconTitle, tabId:tab.id});
        window.willExpand = !window.willExpand;
        chrome.tabs.executeScript(null, {file: "fullscreenr.js"});
      };

      validPageFound = false;
      showPageAction = function(tabId) {
        console.log('showPageAction with tabId:' + tabId);
        validPageFound = true;
        chrome.pageAction.show(tabId);
      };

      messageHandler = function(request, sender, sendResponse) {
        if (request.embeddedVideosFound) {
          console.log('messageHandler with request.embeddedVideosFound:' + request.embeddedVideosFound);
          if (request.embeddedVideosFound > 0) {
            setupPopupIfNecessary(sender.tab.id);
            showPageAction(sender.tab.id);
          }
        } else if (request.toggleExtensionState) {
          chrome.tabs.getSelected(null, toggleExtensionState);
        }
      };

      checkForValidUrl = function(tabId, changeInfo, tab) {
        if (changeInfo.status == 'loading')
          validPageFound = false;

        console.log('checkForValidUrl with tabId:' + tabId + ' changeInfo.status:' + changeInfo.status + ' validPageFound:' + validPageFound);
        if (changeInfo.status == 'loading' && !validPageFound) {
          if (tab.url.indexOf('youtube.com/watch') > -1 || tab.url.indexOf('vimeo.com') > -1 ) {
            setupPopupIfNecessary(tabId);
            showPageAction(tabId);
          }
        } else if (changeInfo.status == 'complete' && !validPageFound) {
          chrome.tabs.executeScript(null, {file: "embeddedVideo.js"});
        }
      };

      chrome.tabs.onUpdated.addListener(checkForValidUrl);
      chrome.pageAction.onClicked.addListener(toggleExtensionState);
      chrome.extension.onRequest.addListener(messageHandler);
    </script>
  </head>
</html>
