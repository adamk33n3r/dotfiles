

matchRegPath = (paths, path, ignored = [])->

    matcher = (list, path)->
        for p in list
            if p instanceof RegExp
                if path.match p
                    return true
            else
                if path is p
                    return true


    if matcher(ignored, path) is true
        return false


    if matcher(paths, path) is true
        return true


    return false


exports.config =

    overrides:
        prod:
            optimize: true
            sourceMaps: false
            plugins: autoReload: enabled: false

    ################################################
    # Base configuration
    ################################################
    #
    # You shouldn't need to touch this most of the time.
    # Only exception is if you *need* a script to be
    # exposed outside of the module wrapper, you must
    # add it to the "paths" array in the conventions.vendor
    # method
    #
    ################################################

    # Disable automatic page reload when coffee recompiles
    plugins:
        autoReload:
            enabled:
                css: on
                js: off

    # this fixes a really stupid built in assumption.
    #
    # conventions.assets - brunch assumes any "assets" folder
    #   means "copy straight into public!"
    #
    # paths.watched - brunch assumes you're going to use their
    #   expected structure, which only allows watching or
    #   compiling in 'app','vendor', and 'test'
    #
    conventions:
        assets: /^wedontneedthiscrap/
        ignored: /.*?\/tests\/.*|.*?\/compiled\/.*/

        # Specifies Which files/paths will NOT be
        # wrapped in the require-y module containers
        vendor: (path)->
            paths = [
                /\/globals\//
                'public/bower_components/wicket/wicket.js'
                'public/bower_components/jsts/lib/javascript.util.js',
                /public\/js\/phpjs/,
                'public/js/leafletjs/leaflet-src.js',
                'public/js/debounce/debounce.js',
            ]

            return matchRegPath paths, path

    # Specifies which locations can be compiled from / watched.
    # If you start adding scripts/styles in some new location,
    # you'd have to add the location here for things to work
    paths:
        watched: [
            'myfarms',
            'public/js',
            'public/css',
            'public/bootstrap-2.3.1',
            'public/bower_components'
        ]
    files:

        ################################################
        # Scripts (Coffee & JS)
        ################################################
        #
        # Here we specify how each output script file is
        # built up. This probably needs touched occasionally
        # when adding new scripts in weird ways (or scripts
        # that must be loaded in a particular order. Which is
        # rare).
        #
        ################################################

        javascripts:
            joinTo:
                ###
                 * NOTE! this has changed a bit. Previously we just said "HAY grab all the external libraries!"
                 * but that resulted in *huge* externals.js file because of redundant (dist + src + lib folders)
                 * copies of the same files. Now we manually list each external library file we need.
                 *
                ###
                'assets/externals.js': (path)->
                    paths = [
                        'public/bower_components/accounting/accounting.js'
                        'public/bower_components/angular/angular.js'
                        'public/bower_components/angular-animate/angular-animate.js'
                        'public/bower_components/angular-sanitize/angular-sanitize.js'
                        'public/bower_components/angular-messages/angular-messages.js'
                        'public/bower_components/angular-resource/angular-resource.js'
                        'public/bower_components/angular-route/angular-route.js'
                        'public/bower_components/angular-ui-bootstrap-bower/ui-bootstrap.js'
                        'public/bower_components/angular-ui-bootstrap-bower/ui-bootstrap-tpls.js'
                        'public/bower_components/ui-select2/src/select2.js'
                        'public/bower_components/angular-plupload/dist/angular-plupload.min.js'
                        'public/bower_components/angular-ui-utils/ui-utils.js'
                        'public/bower_components/angular-ui-utils/ui-utils-ieshiv.js'
                        'public/bower_components/angular-datatables/dist/angular-datatables.js'
                        'public/bower_components/async/lib/async.js'
                        'public/bower_components/bootstrap-datepicker/js/bootstrap-datepicker.js'
                        'public/bower_components/bootstrapx-clickover/js/bootstrapx-clickover.js'
                        'public/bower_components/datepair/jquery.datepair.js'
                        'public/bower_components/google-code-prettify/src/prettify.js'
                        'public/bower_components/hammerjs/hammer.js'
                        'public/bower_components/handsontable/dist_wc/handsontable-table/jquery.handsontable.full.js'
                        'public/bower_components/jquery-maskedinputs/dist/jquery.maskedinput.js'
                        'public/bower_components/jquery-timepicker-jt/jquery.timepicker.js'
                        'public/bower_components/jsrender/jsrender.js'
                        'public/bower_components/jstree-dist/jquery.jstree.js'
                        'public/bower_components/jsts/lib/javascript.util.js'
                        'public/bower_components/jsts/lib/jsts.js'
                        'public/bower_components/knockout.js/knockout.js'
                        'public/bower_components/leaflet.draw/dist/leaflet.draw-src.js',
                        'public/bower_components/leaflet.markerclusterer/dist/leaflet.markercluster-src.js'
                        'public/bower_components/ng-grid-bower/ng-grid.js'
                        'public/bower_components/plupload/js/moxie.js'
                        'public/bower_components/plupload/js/plupload.dev.js'
                        'public/bower_components/plupload/js/jquery.plupload.queue/jquery.plupload.queue.js'
                        'public/bower_components/select2/select2.min.js'
                        'public/bower_components/sockjs/sockjs.js'
                        'public/bower_components/wicket/wicket.js'
                        'public/bower_components/wicket/wicket-leaflet.js'
                        'public/bower_components/moment/moment.js'
                        'public/bower_components/formatter/formatter.js'
                        'public/bower_components/angular-ui-select/dist/select.js'
                        'public/bower_components/spinjs/spin.js'
                        'public/bower_components/angular-spinner/angular-spinner.js'
                        'public/bower_components/leaflet-pip/leaflet-pip.js'
                        'public/bower_components/lodash/dist/lodash.js'

                        # Public JS folder (non-bower libraries)
                        'public/js/Leaflet.Pancontrol/src/L.Control.Pan.js'
                        'public/js/angular-ui-router/angular-ui-router.js'
                        'public/js/datatables/jquery.dataTables.js'
                        'public/js/datatables/FixedColumns.js'
                        'public/js/datatables/datatables-bootstrap.js'
                        'public/js/debounce/debounce.js'
                        'public/js/jquery-ui/jquery-ui.custom.min.js'
                        'public/js/leafletjs/leaflet-src.js'
                        'public/js/nedb/nedb.js'
                        /public\/js\/phpjs/
                        'public/js/smartresize/smartresize.js'
                        'public/js/taffydb/taffy.js'
                        'public/js/jquery.validationEngine.js'
                        'public/js/jquery.validationEngine-en.js'

                        #/public\/bower_components/
                        #/public\/js/
                        'public/bootstrap-2.3.1/docs/assets/js/bootstrap.js'
                    ]

                    ignored = [
                        /taffy\.orig\.js/
                        /public\/bower_components\/jquery\/(src|build|test|speed)/
                        /public\/bower_components\/handsontable\/src/
                    ]

                    return matchRegPath paths, path, ignored

                'assets/grower.js': (path)->
                    paths = [
                        /myfarms\/grower\/scripts/,
                        'myfarms/portal/scripts/handlers/reports/Reports_Boundaries_SubHandler.coffee'
                    ]

                    return matchRegPath paths, path

                'assets/crm.js': (path)->
                    paths = [
                        /myfarms\/crm\/scripts/,
                        'myfarms/portal/scripts/Angular/Register/RegisterController.coffee'
                        'myfarms/portal/scripts/Angular/Register/RegisterService.coffee'
                    ]

                    return matchRegPath paths, path

                'assets/portal.js': (path)->
                    paths = [
                        /myfarms\/portal\/scripts/
                        'myfarms/grower/scripts/handlers/account/dialogs/Set_Locale_Dialog.coffee'
                        'myfarms/grower/scripts/handlers/data/layers/shapefile/Layer_Shapefile_Dialog.coffee'
                        /myfarms\/grower\/scripts\/viewmodels\/data\/shapefile/
                        'myfarms/grower/scripts/handlers/data/layers/Layer_Ears_Rows_Length_Dialog.coffee',
                        'myfarms/grower/scripts/handlers/data/layers/Layer_Stand_Count_Dialog.coffee'
                    ]

                    return matchRegPath paths, path

                'assets/core.js': /myfarms\/core\/scripts/
                'assets/admin.js': /myfarms\/admin\/scripts/

            order:
                after: [
                    'myfarms/core/scripts/globals/modules'
                ]


        ################################################
        # Stylesheets
        ################################################
        #
        # Here we define how each outputed stylesheet is
        # made up. This should not need to be modified
        # very much, as it picks up any new stylesheets
        # automatically (provided they are in a watched
        # location).
        #
        # Only exception is stylsheets that *must* be
        # ordered. In that case, we'd add an "order" key
        # below (as brunch docs describe)
        #
        ################################################
        #
        stylesheets:
            joinTo:
                'assets/core.css': (path)->
                    paths = [
                        /myfarms\/core\/styles/,
                        'public/bootstrap-2.3.1/less/bootstrap.less',
                        'public/css/font-awesome.css',
                        'public/bower_components/leaflet.draw/dist/leaflet.draw.css'
                        'public/js/Leaflet.Pancontrol/src/L.Control.Pan.css'
                        'public/bower_components/leaflet.markerclusterer/dist/MarkerCluster.css'
                        'public/bower_components/jquery-timepicker-jt/jquery.timepicker.css'
                        'public/css/mfValidationEngine.css'
                        'public/bower_components/plupload/js/jquery.plupload.queue/css/jquery.plupload.queue.css'
                        'public/bower_components/jquery-timepicker-jt/jquery.timepicker.css',
                        'public/bower_components/handsontable/dist_wc/handsontable-table/jquery.handsontable.full.css',
                        'public/bower_components/ng-grid-bower/ng-grid.css'
                        'public/bower_components/select2/select2.css'
                        'public/bower_components/select2/select2-bootstrap.css'
                        'public/bower_components/angular-ui-select/dist/select.css'
                    ]

                    return matchRegPath paths, path


                'assets/portal.css': /myfarms\/portal\/styles/

                'assets/grower.css': /myfarms\/grower\/styles/

                'assets/crm.css': /myfarms\/crm\/styles/

                'assets/admin.css': /myfarms\/admin\/styles/


            order:
                before: [
                    'public/bootstrap-2.3.1/less/bootstrap.less',
                    'public/js/Leaflet.Pancontrol/src/L.Control.Pan.css'
                    'public/bower_components/leaflet.markerclusterer/dist/MarkerCluster.css'
                    'public/bower_components/angular-ui-select/dist/select.css'
                ],
                after: [
                    'myfarms/core/styles/plupload/plupload.queue.less'
                    'myfarms/core/styles/select2/select2.less'
                ]

